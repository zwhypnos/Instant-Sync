<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title></title>
    <script type="text/javascript">
    	var callbacks = [];
		var receiver;
		var filter;
		var main;
		var isInit = false;
		var isRegistered = false;
		var isOlderVersion = false;
		
		var tlpreceiver,TelephonyManager;
   		
   		//plusReady封装，若使用mui，可直接使用mui.plusReady()方法；
		var plusReady = function(callback){
		     if (window.plus) {
		        callback();
		    } else {
		        document.addEventListener("plusready", function() {
		            callback();
		        }, false);
		    }
		}
		
		/**
		* 初始化
		*/
		var init = function(callback) {
		    //仅支持Android版本
		    if (plus.os.name !== 'Android') {
		        return;
		    }
		    try {
		        var version = plus.runtime.innerVersion.split('.');
		        isOlderVersion = parseInt(version[version.length - 1]) < 22298;
		        main = plus.android.runtimeMainActivity();
		        var Intent = plus.android.importClass('android.content.Intent');
		        var IntentFilter = plus.android.importClass('android.content.IntentFilter');
		        var SmsMessage = plus.android.importClass('android.telephony.SmsMessage');
		        TelephonyManager = plus.android.importClass('android.telephony.TelephonyManager'); //通话管理
		        var receiverClass = 'io.dcloud.feature.internal.reflect.BroadcastReceiver';
		        if (isOlderVersion) {
		            receiverClass = 'io.dcloud.feature.internal.a.a';
		        }
		        filter = new IntentFilter();
		        var onReceiveCallback = function(context, intent) {
		            try {
		                var action = intent.getAction();
		                if (action == "android.provider.Telephony.SMS_RECEIVED") {
		                    var pdus = intent.getSerializableExtra("pdus");
		                    var msgs = [];
		                    for (var i = 0, len = pdus.length; i < len; i++) {
		                        msgs.push(SmsMessage.createFromPdu(pdus[i]));
		                    }
		                    for (var i = 0, len = callbacks.length; i < len; i++) {
		                        callbacks[i](msgs);
		                    }
		                }
		            } catch (e) {}
		        }
		        var doReceive = function(context, intent){
		        	try{
		        		var action = intent.getAction();
		        		if(action == TelephonyManager.ACTION_PHONE_STATE_CHANGED){
		        			var phoneNumber = intent.getStringExtra(TelephonyManager.EXTRA_INCOMING_NUMBER),
		                        telephony = context.getSystemService(context.TELEPHONY_SERVICE),
		                        state = telephony.getCallState();
		                        if(state == TelephonyManager.CALL_STATE_RINGING){
		                        	if(phoneNumber!=null){
		                        		console.log("打入电话：" + phoneNumber);
		                        	}
		                        }
		        		}
		        	} catch (e) {}
		        }
		        receiver = plus.android.implements(receiverClass, {
		            a: onReceiveCallback,
		            onReceive: onReceiveCallback
		        });
		        tlpreceiver = plus.android.implements(receiverClass, {
		            a: doReceive,
		            onReceive: doReceive
		        });
		        filter.addAction("android.provider.Telephony.SMS_RECEIVED");
		        filter.addAction(TelephonyManager.ACTION_PHONE_STATE_CHANGED);
		        callback && callback();
		    } catch (e) {}
		}
		
		//注册短信监听
		var register = function(callback) {
		    callbacks.push(callback);
		    if (!isInit) {
		        isInit = isRegistered = true;
		        plusReady(function() {
		            init(function() {
		                setTimeout(function() {
		                    //                  console.log('registerReceiver');
		                    try {
		                        if (isOlderVersion) {
		                            main.a(receiver, filter);
		                            main.a(tlpreceiver, filter);
		                        } else {
		                            main.registerReceiver(receiver, filter); //注册监听
		                            main.registerReceiver(tlpreceiver, filter); //注册监听
		                        }
		                    } catch (e) {}
		                }, 300);
		            });
		        });
		    } else if (!isRegistered) {
		        //      console.log('registerReceiver');
		        try {
		            if (isOlderVersion) {
		                main.a(receiver, filter);
		                main.a(tlpreceiver, filter);
		            } else {
		                main.registerReceiver(receiver, filter); //注册监听
		                main.registerReceiver(tlpreceiver, filter); //注册监听
		            }
		        } catch (e) {}
		    }
		};
		
		var handleSMS = function(msgs) {
			var sender;
			var content = '';
		    for (var i = 0, len = msgs.length; i < len; i++) {
		         content += msgs[i].getDisplayMessageBody();
		        if(i==0){
		        	sender = msgs[i].getOriginatingAddress();
		        }
		    }
		    console.log('('+sender+')'+content);
		};
		
		//登录页面注册短信监听事件
		register(handleSMS);
    </script>
</head>
<body>
	
</body>
</html>